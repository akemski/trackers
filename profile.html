<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dark Trackers • Mein Profil</title>

  <style>
    :root {
      --bg0: #050505;
      --bg1: #0b0b10;
      --panel: #101018;
      --panel2: #0e0e16;
      --line: #242436;
      --line2: #2b2b44;
      --text: #ececf4;
      --muted: #b8b8d2;

      --red: #c53f3f;
      --red2: #ff3b3b;

      --glow: 0 0 0 1px rgba(255,59,59,.3), 0 0 5px rgba(255,59,59,.15);
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --radius: 8px;
      --border-color: rgba(37,37,55,.7);
      --border-hover: rgba(209,42,61,.45);
    }

    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Courier New', Courier, monospace;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(176,22,42,.15), transparent 55%),
        radial-gradient(700px 500px at 90% 20%, rgba(209,42,61,.1), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
      font-size: 15px;
      padding: 40px 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      gap: 30px;
      align-items: flex-start;
    }

    /* Linker Profilbereich */
    .profile-section {
      width: 320px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .profile-image-wrapper {
      position: relative;
      width: 100%;
      height: 320px;
    }

    .profile-image {
      width: 100%;
      height: 100%;
      border: 3px solid var(--line);
      background: var(--panel);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 14px;
      text-align: center;
      overflow: hidden;
      position: relative;
    }

    .profile-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-image.clickable {
      cursor: pointer;
    }

    .profile-image.clickable:hover::after {
      content: 'KLICKEN ZUM ÄNDERN';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.85);
      padding: 12px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .image-upload {
      display: none;
    }

    .profile-name {
      background: var(--panel);
      border: 3px solid var(--line);
      padding: 20px;
      text-align: center;
    }

    .profile-name .display-name {
      font-size: 24px;
      font-weight: 700;
      display: block;
    }

    .profile-name .ingame-name {
      font-size: 16px;
      font-weight: 400;
      color: var(--muted);
      display: block;
      margin-top: 8px;
      letter-spacing: 0.5px;
    }

    .profile-status {
      background: var(--panel);
      border: 3px solid var(--line);
      padding: 18px;
      color: var(--muted);
      font-size: 15px;
    }

    .profile-status.view-mode {
      cursor: default;
    }

    .profile-status input {
      width: 100%;
      background: var(--bg1);
      border: 2px solid var(--line2);
      color: var(--text);
      padding: 10px;
      font-family: inherit;
      font-size: 15px;
    }

    .profile-bio {
      background: var(--panel);
      border: 3px solid var(--line);
      padding: 20px;
    }

    .profile-bio h3 {
      font-size: 18px;
      margin-bottom: 12px;
      color: var(--text);
      text-decoration: underline;
    }

    .profile-bio p {
      font-size: 15px;
      line-height: 1.7;
      color: var(--muted);
      white-space: pre-wrap;
    }

    .profile-bio textarea {
      width: 100%;
      background: var(--bg1);
      border: 2px solid var(--line2);
      color: var(--text);
      padding: 10px;
      font-family: inherit;
      font-size: 15px;
      min-height: 150px;
      resize: vertical;
      line-height: 1.7;
    }

    /* Edit/Save/Logout Buttons */
    .action-btn {
      background: var(--panel);
      border: 3px solid var(--line);
      padding: 15px;
      text-align: center;
      cursor: pointer;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.2s;
      font-family: inherit;
      font-size: 14px;
      width: 100%;
    }

    .action-btn:hover {
      border-color: var(--red);
      background: var(--bg1);
    }

    .save-btn {
      background-color: var(--red);
      border-color: var(--red);
      color: white;
    }

    .save-btn:hover {
      background-color: var(--red2);
      border-color: var(--red2);
    }

    .logout-btn {
      margin-top: 10px;
    }

    .logout-btn:hover {
      background: var(--red);
      color: white;
    }

    .hidden {
      display: none !important;
    }

    /* Rechter Hauptbereich */
    .main-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .header-box {
      background: var(--panel);
      border: 3px solid var(--line);
      padding: 30px;
      text-align: center;
    }

    .header-box h1 {
      font-size: 38px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    /* Großer Container um das Grid */
    .areas-container {
      background: var(--panel);
      border: 4px solid var(--line);
      padding: 30px;
    }

    /* 3x3 Grid für die Bereiche */
    .areas-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 25px;
    }

    .box {
      background: var(--bg1);
      border: 3px solid var(--line2);
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      transition: border-color 0.2s ease;
    }

    .box:hover {
      border-color: var(--red);
    }

    .box h3 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .box p {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.6;
      flex: 1;
    }

    .btn {
      display: inline-block;
      background-color: var(--red);
      color: white;
      padding: 12px 24px;
      text-decoration: none;
      font-weight: 700;
      text-align: center;
      transition: background-color 0.2s ease;
      border: 2px solid var(--red);
      cursor: pointer;
      font-family: inherit;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 1px;
    }

    .btn:hover {
      background-color: var(--red2);
      border-color: var(--red2);
    }

    /* Footer */
    .footer-note {
      margin-top: 30px;
      color: rgba(184, 184, 210, 0.6);
      font-size: 11px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-weight: 300;
      text-align: center;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    @media (max-width: 1024px) {
      .container {
        flex-direction: column;
      }

      .profile-section {
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
      }

      .areas-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .areas-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="loading" id="loadingState">
    Lade Profildaten...
  </div>

  <div class="container hidden" id="mainContent">
    <!-- Linker Profilbereich -->
    <aside class="profile-section">
      <!-- Profilbild -->
      <div class="profile-image-wrapper">
        <div class="profile-image" id="profileImage">
          <span>Kein Profilbild</span>
        </div>
        <input type="file" id="imageUpload" class="image-upload" accept="image/*">
      </div>
      
      <!-- Name -->
      <div class="profile-name" id="profileName">
        Lädt...
      </div>
      
      <!-- Status -->
      <div class="profile-status view-mode" id="statusContainer">
        <span id="statusDisplay">Status: Lädt...</span>
        <input type="text" id="statusInput" class="hidden" placeholder="z.B. Online, Beschäftigt, AFK...">
      </div>
      
      <!-- Bio -->
      <div class="profile-bio">
        <h3>Bio der Person</h3>
        <div id="bioContainer">
          <p id="bioDisplay">Lädt Bio...</p>
          <textarea id="bioInput" class="hidden" placeholder="Schreibe etwas über dich..."></textarea>
        </div>
      </div>

      <!-- Edit/Save Button -->
      <button class="action-btn" id="editBtn">Profil Bearbeiten</button>
      <button class="action-btn save-btn hidden" id="saveBtn">Änderungen Speichern</button>
      <button class="action-btn hidden" id="cancelBtn">Abbrechen</button>

      <!-- Logout Button -->
      <button class="action-btn logout-btn" id="logoutBtn">Logout</button>
    </aside>

    <!-- Rechter Hauptbereich -->
    <main class="main-section">
      <!-- Header -->
      <header class="header-box">
        <h1>Dark Trackers</h1>
      </header>

      <!-- 3x3 Grid -->
      <div class="areas-container">
        <div class="areas-grid">
          <div class="box">
            <h3>Member Liste</h3>
            <p>Hier findest du die Liste der Mitglieder des Dark Trackers Clubs.</p>
            <a href="members.html" class="btn">Öffnen</a>
          </div>

          <div class="box">
            <h3>Forum</h3>
            <p>Diskutiere mit anderen über die neuesten Themen!</p>
            <a href="forum.html" class="btn">Öffnen</a>
          </div>

          <div class="box">
            <h3>Dressur</h3>
            <p>Trainiere deine Skills und verbessere deine Dressurfähigkeiten.</p>
            <a href="dressur.html" class="btn">Öffnen</a>
          </div>

          <div class="box">
            <h3>Platzhalter</h3>
            <p>Kurze Beschreibung des Bereichs.</p>
            <a href="#" class="btn">Öffnen</a>
          </div>

          <div class="box">
            <h3>Platzhalter</h3>
            <p>Kurze Beschreibung des Bereichs.</p>
            <a href="#" class="btn">Öffnen</a>
          </div>

          <div class="box">
            <h3>Platzhalter</h3>
            <p>Kurze Beschreibung des Bereichs.</p>
            <a href="#" class="btn">Öffnen</a>
          </div>

          <div class="box">
            <h3>Platzhalter</h3>
            <p>Kurze Beschreibung des Bereichs.</p>
            <a href="#" class="btn">Öffnen</a>
          </div>

          <div class="box">
            <h3>Platzhalter</h3>
            <p>Kurze Beschreibung des Bereichs.</p>
            <a href="#" class="btn">Öffnen</a>
          </div>

          <div class="box">
            <h3>Platzhalter</h3>
            <p>Kurze Beschreibung des Bereichs.</p>
            <a href="#" class="btn">Öffnen</a>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="footer-note">
        All actions logged • Protocol DT-01 • Compartmentalized access
      </footer>
    </main>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyASTwGk7GYqOaDWTRB77Qw5aE_RnWzcHic",
      authDomain: "trackers-ce3fb.firebaseapp.com",
      projectId: "trackers-ce3fb",
      storageBucket: "trackers-ce3fb.firebasestorage.app",
      messagingSenderId: "385800199430",
      appId: "1:385800199430:web:93fe876ed4dfc6550a9287",
      measurementId: "G-VXYWY0ELKF"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM Elements
    const loadingState = document.getElementById('loadingState');
    const mainContent = document.getElementById('mainContent');
    const profileImage = document.getElementById('profileImage');
    const imageUpload = document.getElementById('imageUpload');
    const profileName = document.getElementById('profileName');
    const statusDisplay = document.getElementById('statusDisplay');
    const statusInput = document.getElementById('statusInput');
    const statusContainer = document.getElementById('statusContainer');
    const bioDisplay = document.getElementById('bioDisplay');
    const bioInput = document.getElementById('bioInput');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // State
    let editMode = false;
    let currentUser = null;
    let userDocId = null;
    let originalData = {};

    // Check Login
    const username = localStorage.getItem('clubUser');
    if (!username) {
      window.location.href = 'index.html';
    }

    // Load User Data
    async function loadUserData() {
      try {
        const snap = await db.collection('users')
          .where('username', '==', username)
          .limit(1)
          .get();

        if (snap.empty) {
          alert('User nicht gefunden!');
          window.location.href = 'index.html';
          return;
        }

        const doc = snap.docs[0];
        userDocId = doc.id;
        currentUser = doc.data();

        // Store original data
        originalData = {
          status: currentUser.status || 'Online',
          bio: currentUser.bio || 'Noch keine Bio vorhanden.',
          profileImage: currentUser.profileImage || null
        };

        // Display data
        displayUserData();
        
        loadingState.classList.add('hidden');
        mainContent.classList.remove('hidden');

      } catch (error) {
        console.error('Fehler beim Laden:', error);
        alert('Fehler beim Laden der Daten!');
      }
    }

    // Display User Data
    function displayUserData() {
      // Name + Ingame Name anzeigen
      const displayName = currentUser.displayName || currentUser.username || 'Unbekannt';
      const ingameName = currentUser.ingameName || '';
      
      if (ingameName) {
        profileName.innerHTML = `
          <span class="display-name">${displayName}</span>
          <span class="ingame-name">${ingameName}</span>
        `;
      } else {
        profileName.innerHTML = `<span class="display-name">${displayName}</span>`;
      }
      
      // Status
      const status = currentUser.status || 'Online';
      statusDisplay.textContent = `Status: ${status}`;
      statusInput.value = status;

      // Bio
      const bio = currentUser.bio || 'Noch keine Bio vorhanden.';
      bioDisplay.textContent = bio;
      bioInput.value = bio;

      // Profile Image
      if (currentUser.profileImage) {
        profileImage.innerHTML = `<img src="${currentUser.profileImage}" alt="Profilbild">`;
      } else {
        profileImage.innerHTML = '<span>Kein Profilbild</span>';
      }
    }

    // Toggle Edit Mode
    function toggleEditMode(enable) {
      editMode = enable;

      if (enable) {
        // Edit Mode aktivieren
        statusDisplay.classList.add('hidden');
        statusInput.classList.remove('hidden');
        bioDisplay.classList.add('hidden');
        bioInput.classList.remove('hidden');
        profileImage.classList.add('clickable');
        
        editBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
        cancelBtn.classList.remove('hidden');
      } else {
        // Edit Mode deaktivieren
        statusDisplay.classList.remove('hidden');
        statusInput.classList.add('hidden');
        bioDisplay.classList.remove('hidden');
        bioInput.classList.add('hidden');
        profileImage.classList.remove('clickable');
        
        editBtn.classList.remove('hidden');
        saveBtn.classList.add('hidden');
        cancelBtn.classList.add('hidden');
      }
    }

    // Handle Image Upload
    profileImage.addEventListener('click', () => {
      if (editMode) {
        imageUpload.click();
      }
    });

    imageUpload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Bitte nur Bilder hochladen!');
        return;
      }

      // Validate file size (max 1MB for Firestore)
      if (file.size > 1 * 1024 * 1024) {
        alert('Bild ist zu groß! Max. 1MB erlaubt (für kleinere Bilder bitte online komprimieren).');
        return;
      }

      try {
        // Show loading state
        profileImage.innerHTML = '<span>Bild wird hochgeladen...</span>';

        // Convert image to base64
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const base64Image = event.target.result;

            // Update Firestore with base64 image
            await db.collection('users').doc(userDocId).update({
              profileImage: base64Image
            });

            // Update local data
            currentUser.profileImage = base64Image;
            originalData.profileImage = base64Image;

            // Show the uploaded image
            profileImage.innerHTML = `<img src="${base64Image}" alt="Profilbild">`;
            
            alert('Profilbild erfolgreich hochgeladen!');

          } catch (error) {
            console.error('Speichern Fehler:', error);
            alert('Fehler beim Speichern des Bildes: ' + error.message);
            displayUserData();
          }
        };

        reader.onerror = () => {
          alert('Fehler beim Lesen der Datei!');
          displayUserData();
        };

        reader.readAsDataURL(file);

      } catch (error) {
        console.error('Upload Fehler:', error);
        alert('Fehler beim Hochladen des Bildes: ' + error.message);
        displayUserData();
      }
    });

    // Save Changes
    saveBtn.addEventListener('click', async () => {
      try {
        const newStatus = statusInput.value.trim();
        const newBio = bioInput.value.trim();

        if (!newStatus) {
          alert('Status darf nicht leer sein!');
          return;
        }

        await db.collection('users').doc(userDocId).update({
          status: newStatus,
          bio: newBio
        });

        currentUser.status = newStatus;
        currentUser.bio = newBio;
        originalData.status = newStatus;
        originalData.bio = newBio;

        displayUserData();
        toggleEditMode(false);
        alert('Änderungen gespeichert!');

      } catch (error) {
        console.error('Speichern Fehler:', error);
        alert('Fehler beim Speichern!');
      }
    });

    // Cancel Edit
    cancelBtn.addEventListener('click', () => {
      statusInput.value = originalData.status;
      bioInput.value = originalData.bio;
      toggleEditMode(false);
    });

    // Edit Button
    editBtn.addEventListener('click', () => {
      toggleEditMode(true);
    });

    // Logout
    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('clubUser');
      localStorage.removeItem('clubRole');
      window.location.href = 'index.html';
    });

    // Load data on page load
    loadUserData();
  </script>
</body>
</html>
